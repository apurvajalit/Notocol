@{
    
    ViewBag.Title = "Home";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    
    .top-buffer {  }
    #keyword{
        min-width: 450px;
        /*min-width: 100%;*/
        
    }
    body,html{
        height:100%;

    }
     #outer {
        position: relative;
    }
    #outer a {
        position: absolute;
        top: 0;
        left: 0;
    }
    #outer input {
         text-indent: 16px;
    }

    .left-dotted-border{
        border-left: 1px dotted  #333;
    }
    .bottom-dotted-border{
        border-bottom: 1px dotted  #333;
    }
    .min-content-height{
        min-height:100%;
    }
     #dashboard-data {
        width: 100%;
        height: 100%;
        min-height: 50vh;
        display: block;
    }
     
    .pageBox{
        
        border: 1px solid gray ;
        border-radius:10px;
        min-height:150px;
        position:relative;
        margin-bottom:10px;
        
        
        
     }
    .pageBoxContainer{
        border: 1px solid gray ;
        border-radius:10px;
        min-height:150px;
        position:relative;
        margin-bottom:10px;
     }

    .pageTags{
        position: absolute;
        bottom: 2px;
        left: 5px;
        font-size:12px ;
        /*background-color:#F9F9F9;*/
        
    }
    .page-box-footer{
        
        
    }
    .page-user-info{
        position: absolute;
        bottom: -5px;
        left: 5px;
        
    }
    .viewNotesButton{
        position: absolute;
        bottom: 5px;
        right: 5px;
    }
    .single-note-box{
        background-color:#F9F9F9;
  
        border-radius:5px;
        margin-bottom:3%;
     }

    .scrollable-menu {
        height: auto;
        max-height: 200px;
        overflow-x: hidden;
    }

    .page-title{
        
        font-family: 'Source Sans Pro', sans-serif;
        font-size: 125%;

    }
    .page-subtitle{
        
        font-family: 'Source Sans Pro', sans-serif;
        font-size: 75%;

    }
    .list-inline>li {
      margin-right: -12px;
    }

    .input-group .bootstrap-tagsinput {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        width: 100%;
        margin-bottom: 1px;

        
    }
    .table-container {
  display: table;
}

.table-container .table-row {
  height: 100%;
  display: table-row;
}

.table-container .table-row .table-col {
  display: table-cell;
  float: none;
  vertical-align: top;
  
}

.table-col{
    background-color:#F9F9F9;
    /*border-right:1px groove gray;
    border-bottom:1px groove gray;*/
    border: 8px solid #ffffff;
    border-radius:20px;
}
    /*#tagButton{
        border: none;
        background-color: #F9F9F9;

    }*/
</style>
<link href="~/Content/bootstrap-tagsinput.css" rel="stylesheet" type="text/css" />
<div>
    <div id="searchBar" class="row top-buffer">
        <div class="col-sm-12">
            <div class="col-sm-12 text-center">
                <form class="form-inline" role="form" id="searchParamters" style="min-width:100%">
                    <label class="sr-only" id="keywordlabel"></label>
                    <input type="text" class="form-control" id="keyword" placeholder="Enter keywords for search" value=@ViewBag.QueryFilter>
                    <label id="tag-tree">under</label>
                    <input type="text" id="filterTag"  data-provide="typeahead" placeholder="Enter tags to filter">
                    @*<button class="btn btn-default" id="searchForPages">Search</button>*@
                </form>
                <br />
            </div>
        </div>
    </div>
    <hr size="2" />

    <div class="row" id="tabs">
        <div class="col-sm-12">
            <ul class="nav nav-tabs">
                <li class="active" data-toggle="tab" value=0><a href="#">My Collection</a></li>
                <li data-toggle="tab" value=1><a href="#">Others</a></li>
             </ul>
        </div>
    </div>

    <div id="dashboard-data" >
        <div class="row top-buffer">
            <div class="col-sm-12">
                <button type="button" class="btn btn-default" style="float:right" id="refreshPages"><span class="glyphicon glyphicon-refresh"></span></button>
            </div>
       </div>
        <br />
        <div class="row top-buffer" style="min-height: 100vh">
            <div class="col-sm-12 min-content-height ">
                <div id="pages" class="container table-container"></div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script src="~/Scripts/boostrap3-typeahead.min.js" type="text/javascript"></script>
    <script src="~/Scripts/bootstrap-tagsinput.js" type="text/javascript"></script>
    
    <script>
    var getOwnTagNamesUrl = "/Tag/GetCurrentUserTags";
    var getAllTagNamesUrl = "/Tag/GetAllUserTags";
    var searchTagString= "";
    var sourceListUrl = "/Source/SourceItems";
    var urlToUse = getOwnTagNamesUrl;
    var tabSelected = 0;

    function GetPages() {
        var keywordsEntered = $('#keyword').val();
        var tagsEntered = $('#filterTag').val();
        var userID = '@Session["userID"]';
            $.ajax({
                // Reload the pages based on current given filter
                url: sourceListUrl,
                type: 'Get',
                data: { "keywordFilter": keywordsEntered, "tagFilter": tagsEntered,"tab": tabSelected},
                datatype: 'html'
            })
            .success(function (data) {
                console.log("For keywords:" + keywordsEntered + " and tags:" + searchTagString + " received data");
                $("#pages").html(data);

            })
            .error(function(xhr, status){
                console.log("something seems wrong with status " + status + " " + xhr);
                setTimeout(GetPages, 5000);

            });
        }

        function UpdateTagNameSource(){
            urlToUse = (tabSelected == "0")?getOwnTagNamesUrl:getAllTagNamesUrl;

            //$.get(urlToUse, function(tagData){
            //    alert("Tag data fetched!");
            var autocomplete = $('#filterTag').typeahead();
            autocomplete.data('typeahead').source = function (query, process) {
                return $.get(urlToUse+'?q=' + query);
            }
        }

        function AddTagToTagInput(value){
            //var element = {};
            //element.Name = value;
            $('#filterTag').tagsinput('add', value);
        };

        $(function(){

            var prefilledTags = '@(ViewBag.TagFilter)';
            
            $('#filterTag').tagsinput({
                //itemValue: 'Name',
                //itemText: 'Name',
                typeahead: {
                    source: function (query, process) {
                        return $.get(urlToUse+'?q=' + query);
                    },
                    //displayKey: 'Name',
                    //source: tagData,
                    afterSelect: function (val) {
                    this.$element.val("");
                },
                displayText:function(a) {
                    return a
                },
                autoSelect: true,
                
                }
            });

            if(prefilledTags){
                $.each(prefilledTags.split(','), function(index, value) {
                    AddTagToTagInput(value);
                });
                
            }
        GetPages();
        $('[data-toggle="tab"]').click(function(e) {
            var $this = $(this);
            tabSelected = $this.attr('value');
            GetPages();
            UpdateTagNameSource();
            $this.tab('show');

            return false;
        });

        $("#refreshPages").on("click", function () {
            GetPages();
        });

        $("#searchForPages").on("click", function () {
            GetPages();
        });

        $("#filterTag").on("change", GetPages);
        $('#keyword').on("keyup", GetPages);

    });



    </script>
    
    <script>

        

        if (@ViewBag.RefreshExtension ) {
            // The ID of the extension we want to talk to.
            var editorExtensionId = "namhfjepbaaecpmpgehfppgnhhgaflne";

            // Make a simple request:
            chrome.runtime.sendMessage(editorExtensionId, { reloadExtension: "true" },
              function (response) {

              });
        }
    
        

        

    </script>

}    